<!DOCTYPE html><html lang="fa" dir="rtl"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کالری‌شمار هوشمند</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f5ff',
                            100: '#e6edff',
                            200: '#ccd9ff',
                            300: '#b3c6ff',
                            400: '#8099ff',
                            500: '#5D5CDE',
                            600: '#3333cc',
                            700: '#2929a3',
                            800: '#1f1f7a',
                            900: '#191966',
                            950: '#0f0f3d',
                        }
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.5s ease-in-out',
                        'slideInUp': 'slideInUp 0.5s ease-in-out',
                        'pulse-slow': 'pulse 3s ease-in-out infinite',
                        'shake': 'shake 0.5s ease-in-out',
                        'scale': 'scale 0.3s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideInUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-5px)' },
                            '20%, 40%, 60%, 80%': { transform: 'translateX(5px)' },
                        },
                        scale: {
                            '0%': { transform: 'scale(0.95)' },
                            '70%': { transform: 'scale(1.05)' },
                            '100%': { transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif;
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .food-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
            cursor: pointer;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
        
        /* Custom Tab Styling */
        .tab-container .tab {
            position: relative;
            overflow: hidden;
        }
        
        .tab-container .active-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: currentColor;
            animation: slideInTab 0.3s ease-out forwards;
        }
        
        @keyframes slideInTab {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        /* Modal animation */
        .modal-enter {
            animation: modal-fade-in 0.3s ease-out forwards;
        }
        
        .modal-backdrop-enter {
            animation: backdrop-fade-in 0.3s ease-out forwards;
        }
        
        @keyframes modal-fade-in {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes backdrop-fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* Chart container size fixes */
        .chart-container {
            position: relative;
            height: 0;
            width: 100%;
            padding-bottom: 70%; /* Aspect ratio 10:7 */
        }
        
        .chart-container canvas {
            position: absolute;
            height: 100%;
            width: 100%;
            left: 0;
            top: 0;
        }
        
        /* Force RTL table headers */
        th.force-rtl {
            direction: rtl !important;
            text-align: right !important;
        }
        
        /* Loading spinner */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5D5CDE;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure proper spacing on mobile */
        @media (max-width: 640px) {
            .mobile-spacing {
                margin-bottom: 1rem;
            }
            
            .mobile-p-adjust {
                padding: 0.75rem !important;
            }
            
            .mobile-text-adjust {
                font-size: 0.875rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center space-x-reverse space-x-3">
            <div class="loading-spinner"></div>
            <span id="loading-text">در حال بارگذاری...</span>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop-enter">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-auto modal-enter">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-primary-600 dark:text-primary-400 mb-4">ورود به کالری‌شمار هوشمند</h2>
                
                <div id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium mb-1">ایمیل</label>
                        <input type="email" id="login-email" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="example@email.com">
                    </div>
                    
                    <div>
                        <label for="login-password" class="block text-sm font-medium mb-1">رمز عبور</label>
                        <input type="password" id="login-password" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="رمز عبور خود را وارد کنید">
                    </div>
                    
                    <div id="login-error" class="hidden text-red-500 text-sm"></div>
                    
                    <button id="login-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">ورود</button>
                    <button id="show-register-btn" class="w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold py-3 px-4 rounded-md transition duration-300">ثبت نام</button>
                    <button id="offline-mode-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">ادامه بدون ورود (حالت آفلاین)</button>
                </div>
                
                <div id="register-form" class="hidden space-y-4">
                    <div>
                        <label for="register-name" class="block text-sm font-medium mb-1">نام (اختیاری)</label>
                        <input type="text" id="register-name" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="نام شما">
                    </div>
                    
                    <div>
                        <label for="register-email" class="block text-sm font-medium mb-1">ایمیل</label>
                        <input type="email" id="register-email" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="example@email.com">
                    </div>
                    
                    <div>
                        <label for="register-password" class="block text-sm font-medium mb-1">رمز عبور</label>
                        <input type="password" id="register-password" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="رمز عبور (حداقل 6 کاراکتر)">
                    </div>
                    
                    <div id="register-error" class="hidden text-red-500 text-sm"></div>
                    
                    <button id="register-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">ثبت نام</button>
                    <button id="show-login-btn" class="w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold py-3 px-4 rounded-md transition duration-300">بازگشت به ورود</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal for first-time users -->
    <div id="onboarding-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop-enter">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-auto modal-enter">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-primary-600 dark:text-primary-400 mb-4">تنظیم اهداف اولیه</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">لطفاً اهداف تغذیه‌ای خود را تنظیم کنید:</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="onboard-calorie-goal" class="block text-sm font-medium mb-1">هدف کالری روزانه (کیلوکالری)</label>
                        <input type="number" id="onboard-calorie-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" value="2000" min="1000" max="5000" step="50">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="onboard-protein-goal" class="block text-sm font-medium mb-1">پروتئین (گرم)</label>
                            <input type="number" id="onboard-protein-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" value="80" min="0" max="300" step="1">
                        </div>
                        <div>
                            <label for="onboard-carbs-goal" class="block text-sm font-medium mb-1">کربوهیدرات (گرم)</label>
                            <input type="number" id="onboard-carbs-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" value="250" min="0" max="500" step="1">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="onboard-fat-goal" class="block text-sm font-medium mb-1">چربی (گرم)</label>
                            <input type="number" id="onboard-fat-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" value="65" min="0" max="200" step="1">
                        </div>
                        <div>
                            <label for="onboard-water-goal" class="block text-sm font-medium mb-1">آب (لیتر)</label>
                            <input type="number" id="onboard-water-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" value="2.5" min="0" max="10" step="0.1">
                        </div>
                    </div>
                    
                    <button id="onboard-complete-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 mt-2">شروع کنید</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop-enter">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-auto modal-enter">
            <div class="p-6">
                <h2 id="confirm-title" class="text-xl font-bold mb-4">تأیید عملیات</h2>
                <p id="confirm-message" class="text-gray-600 dark:text-gray-400 mb-6">آیا از انجام این عملیات اطمینان دارید؟</p>
                
                <div class="flex justify-end space-x-reverse space-x-2">
                    <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md transition duration-200">انصراف</button>
                    <button id="confirm-ok" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition duration-200">تأیید</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Import Modal -->
    <div id="import-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop-enter">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-auto modal-enter">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4">بازیابی اطلاعات</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">لطفاً فایل JSON حاوی اطلاعات برنامه را انتخاب کنید:</p>
                
                <div class="space-y-4">
                    <input type="file" id="import-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 dark:file:bg-primary-900 dark:file:text-primary-400" accept=".json">
                    
                    <div id="import-error" class="hidden text-red-500 text-sm"></div>
                    
                    <div class="flex justify-end space-x-reverse space-x-2">
                        <button id="import-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md transition duration-200">انصراف</button>
                        <button id="import-confirm" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md transition duration-200">بازیابی</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container max-w-5xl mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div class="text-center md:text-right mb-4 md:mb-0">
                <h1 class="text-3xl font-bold text-primary-600 dark:text-primary-400 mb-1">کالری‌شمار هوشمند</h1>
                <p class="text-gray-600 dark:text-gray-400">تحلیل دقیق مصرف کالری و مواد مغذی روزانه</p>
                <div id="connection-status" class="text-xs mt-1">
                    <span id="online-status" class="text-green-600 dark:text-green-400">● آنلاین</span>
                    <span id="offline-status" class="hidden text-yellow-600 dark:text-yellow-400">● آفلاین</span>
                </div>
            </div>
            <div class="flex flex-wrap justify-center space-x-reverse space-x-2">
                <button id="sync-btn" class="hidden bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 font-medium py-2 px-4 rounded-md transition duration-300 flex items-center text-sm mb-2 sm:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    همگام‌سازی
                </button>
                <button id="backup-btn" class="bg-primary-100 hover:bg-primary-200 dark:bg-primary-900 dark:hover:bg-primary-800 text-primary-700 dark:text-primary-300 font-medium py-2 px-4 rounded-md transition duration-300 flex items-center text-sm mb-2 sm:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    پشتیبان‌گیری
                </button>
                <button id="restore-btn" class="bg-primary-100 hover:bg-primary-200 dark:bg-primary-900 dark:hover:bg-primary-800 text-primary-700 dark:text-primary-300 font-medium py-2 px-4 rounded-md transition duration-300 flex items-center text-sm mb-2 sm:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    بازیابی
                </button>
                <button id="theme-toggle" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 p-2 rounded-md transition duration-300 mb-2 sm:mb-0">
                    <svg id="dark-icon" class="hidden dark:block h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path>
                    </svg>
                    <svg id="light-icon" class="block dark:hidden h-5 w-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>
                <button id="logout-btn" class="hidden bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 font-medium py-2 px-4 rounded-md transition duration-300 flex items-center text-sm mb-2 sm:mb-0">
                    خروج
                </button>
            </div>
        </header>

        <!-- Tab Container -->
        <div class="tab-container mb-6">
            <div class="flex flex-wrap border-b dark:border-gray-700">
                <button id="tab-tracking" class="tab active-tab text-primary-600 dark:text-primary-400 py-3 px-4 text-sm font-medium">
                    ثبت روزانه
                </button>
                <button id="tab-database" class="tab text-gray-500 dark:text-gray-400 py-3 px-4 text-sm font-medium">
                    مدیریت غذاها
                </button>
                <button id="tab-reports" class="tab text-gray-500 dark:text-gray-400 py-3 px-4 text-sm font-medium">
                    گزارش‌ها
                </button>
                <button id="tab-settings" class="tab text-gray-500 dark:text-gray-400 py-3 px-4 text-sm font-medium">
                    تنظیمات
                </button>
            </div>
        </div>

        <!-- Tracking Tab Content -->
        <div id="tracking-content" class="animate-fadeIn">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Left Column - Daily Stats -->
                <div class="col-span-1 space-y-4">
                    <!-- Date Selector -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">تاریخ</h2>
                        <input type="date" id="current-date" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600">
                    </div>

                    <!-- Daily Goal -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">هدف روزانه</h2>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="col-span-2">
                                    <label for="calorie-goal" class="block text-sm mb-1">کالری روزانه (کیلوکالری)</label>
                                    <input type="number" id="calorie-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" min="1000" max="5000" step="50">
                                </div>
                                <div>
                                    <label for="protein-goal" class="block text-sm mb-1">پروتئین (گرم)</label>
                                    <input type="number" id="protein-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" min="0" max="300" step="1">
                                </div>
                                <div>
                                    <label for="carbs-goal" class="block text-sm mb-1">کربوهیدرات (گرم)</label>
                                    <input type="number" id="carbs-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" min="0" max="500" step="1">
                                </div>
                                <div>
                                    <label for="fat-goal" class="block text-sm mb-1">چربی (گرم)</label>
                                    <input type="number" id="fat-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" min="0" max="200" step="1">
                                </div>
                                <div>
                                    <label for="water-goal" class="block text-sm mb-1">آب (لیتر)</label>
                                    <input type="number" id="water-goal" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" min="0" max="10" step="0.1">
                                </div>
                                <div class="col-span-2 mt-2">
                                    <button id="update-goals" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                                        به‌روزرسانی اهداف
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Summary -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">خلاصه امروز</h2>
                        
                        <!-- Calorie Progress -->
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium">کالری</span>
                                <span id="calorie-summary" class="text-sm font-bold">0 / 0 کیلوکالری</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div id="calorie-progress" class="progress-bar bg-primary-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Protein Progress -->
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium">پروتئین</span>
                                <span id="protein-summary" class="text-sm font-bold">0 / 0 گرم</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div id="protein-progress" class="progress-bar bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Carbs Progress -->
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium">کربوهیدرات</span>
                                <span id="carbs-summary" class="text-sm font-bold">0 / 0 گرم</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div id="carbs-progress" class="progress-bar bg-yellow-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Fat Progress -->
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium">چربی</span>
                                <span id="fat-summary" class="text-sm font-bold">0 / 0 گرم</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div id="fat-progress" class="progress-bar bg-red-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Water Progress -->
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium">آب</span>
                                <span id="water-summary" class="text-sm font-bold">0 / 0 لیتر</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div id="water-progress" class="progress-bar bg-blue-400 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button id="add-water" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-md transition duration-300 text-sm">
                                + افزودن ۲۵۰ میلی‌لیتر آب
                            </button>
                            <button id="reset-water" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold py-2 px-3 rounded-md transition duration-300 text-sm">
                                بازنشانی آب
                            </button>
                        </div>
                    </div>
                    
                    <!-- Macro Distribution -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">توزیع درشت‌مغذی‌ها</h2>
                        <div class="chart-container">
                            <canvas id="macros-chart"></canvas>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mt-4 text-center text-xs">
                            <div class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 p-2 rounded">
                                <div class="font-bold">پروتئین</div>
                                <div id="protein-percent">0%</div>
                            </div>
                            <div class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 p-2 rounded">
                                <div class="font-bold">کربوهیدرات</div>
                                <div id="carbs-percent">0%</div>
                            </div>
                            <div class="bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 p-2 rounded">
                                <div class="font-bold">چربی</div>
                                <div id="fat-percent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Middle & Right Columns - Food Entry & Log -->
                <div class="col-span-1 lg:col-span-2 space-y-4">
                    <!-- Meal Type Selection -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                            <button class="meal-type-btn bg-primary-100 dark:bg-primary-900 text-primary-600 dark:text-primary-300 py-2 px-4 rounded-md text-sm font-medium transition duration-300" data-meal="breakfast">صبحانه</button>
                            <button class="meal-type-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 py-2 px-4 rounded-md text-sm font-medium transition duration-300" data-meal="lunch">ناهار</button>
                            <button class="meal-type-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 py-2 px-4 rounded-md text-sm font-medium transition duration-300" data-meal="dinner">شام</button>
                            <button class="meal-type-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 py-2 px-4 rounded-md text-sm font-medium transition duration-300" data-meal="snack">میان‌وعده</button>
                        </div>
                    </div>
                    
                    <!-- Food Search & Add -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">افزودن غذا</h2>
                        <div class="mb-4">
                            <div class="relative">
                                <input type="text" id="food-search" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="جستجوی غذا...">
                                <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                                    <div id="search-loading" class="hidden loading-spinner w-4 h-4"></div>
                                </div>
                                <div id="search-results" class="hidden absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-md shadow-lg max-h-60 overflow-auto">
                                    <!-- Search results will appear here -->
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-center">
                                غذای موردنظر را جستجو کنید یا از فرم زیر برای افزودن غذای سفارشی استفاده کنید
                            </div>
                        </div>
                        
                        <div id="selected-food" class="hidden animate-scale">
                            <div class="border rounded-md p-3 dark:border-gray-700 mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 id="selected-food-name" class="font-bold"></h3>
                                    <span id="selected-food-calories" class="text-sm text-gray-600 dark:text-gray-400"></span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <span class="text-xs text-gray-600 dark:text-gray-400">پروتئین:</span>
                                        <span id="selected-food-protein" class="text-xs font-medium"></span>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-600 dark:text-gray-400">کربوهیدرات:</span>
                                        <span id="selected-food-carbs" class="text-xs font-medium"></span>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-600 dark:text-gray-400">چربی:</span>
                                        <span id="selected-food-fat" class="text-xs font-medium"></span>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-600 dark:text-gray-400">فیبر:</span>
                                        <span id="selected-food-fiber" class="text-xs font-medium"></span>
                                    </div>
                                </div>
                                
                                <div class="flex items-center">
                                    <label for="food-amount" class="text-sm ml-2">مقدار (گرم):</label>
                                    <input type="number" id="food-amount" class="border rounded w-20 py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="100" min="1" max="1000" step="5">
                                    <button id="add-food-btn" class="mr-auto bg-primary-600 hover:bg-primary-700 text-white font-bold py-1 px-3 rounded-md text-sm transition duration-300">افزودن</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="custom-food" class="">
                            <h3 class="font-bold text-sm mb-2">افزودن غذای سفارشی</h3>
                            <div class="border rounded-md p-3 dark:border-gray-700">
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div class="col-span-2">
                                        <label for="custom-food-name" class="block text-xs mb-1">نام غذا</label>
                                        <input type="text" id="custom-food-name" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="مثال: سالاد مرغ">
                                    </div>
                                    <div>
                                        <label for="custom-food-amount" class="block text-xs mb-1">مقدار (گرم)</label>
                                        <input type="number" id="custom-food-amount" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="100" min="1" max="1000">
                                    </div>
                                    <div>
                                        <label for="custom-food-calories" class="block text-xs mb-1">کالری (کیلوکالری)</label>
                                        <input type="number" id="custom-food-calories" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0">
                                    </div>
                                    <div>
                                        <label for="custom-food-protein" class="block text-xs mb-1">پروتئین (گرم)</label>
                                        <input type="number" id="custom-food-protein" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0" step="0.1">
                                    </div>
                                    <div>
                                        <label for="custom-food-carbs" class="block text-xs mb-1">کربوهیدرات (گرم)</label>
                                        <input type="number" id="custom-food-carbs" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0" step="0.1">
                                    </div>
                                    <div>
                                        <label for="custom-food-fat" class="block text-xs mb-1">چربی (گرم)</label>
                                        <input type="number" id="custom-food-fat" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0" step="0.1">
                                    </div>
                                    <div>
                                        <label for="custom-food-fiber" class="block text-xs mb-1">فیبر (گرم)</label>
                                        <input type="number" id="custom-food-fiber" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0" step="0.1">
                                    </div>
                                    <div>
                                        <button id="add-custom-food-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-1 px-3 rounded-md text-sm transition duration-300">افزودن به وعده</button>
                                    </div>
                                    <div>
                                        <button id="save-to-database-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm transition duration-300">ذخیره در پایگاه داده</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Today's Food Log -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-bold text-primary-600 dark:text-primary-400">لیست غذاهای امروز</h2>
                            <button id="clear-day-log" class="text-red-500 hover:text-red-600 text-sm underline">پاک کردن همه</button>
                        </div>
                        
                        <div id="food-log-container" class="space-y-4">
                            <div id="breakfast-log" class="border-b dark:border-gray-700 pb-3">
                                <h3 class="font-bold text-sm mb-2 flex justify-between">
                                    <span>صبحانه</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400" id="breakfast-calories">0 کالری</span>
                                </h3>
                                <div class="food-items space-y-2">
                                    <div class="text-sm text-gray-500 dark:text-gray-400 text-center empty-message">موردی ثبت نشده است.</div>
                                </div>
                            </div>
                            
                            <div id="lunch-log" class="border-b dark:border-gray-700 pb-3">
                                <h3 class="font-bold text-sm mb-2 flex justify-between">
                                    <span>ناهار</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400" id="lunch-calories">0 کالری</span>
                                </h3>
                                <div class="food-items space-y-2">
                                    <div class="text-sm text-gray-500 dark:text-gray-400 text-center empty-message">موردی ثبت نشده است.</div>
                                </div>
                            </div>
                            
                            <div id="dinner-log" class="border-b dark:border-gray-700 pb-3">
                                <h3 class="font-bold text-sm mb-2 flex justify-between">
                                    <span>شام</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400" id="dinner-calories">0 کالری</span>
                                </h3>
                                <div class="food-items space-y-2">
                                    <div class="text-sm text-gray-500 dark:text-gray-400 text-center empty-message">موردی ثبت نشده است.</div>
                                </div>
                            </div>
                            
                            <div id="snack-log">
                                <h3 class="font-bold text-sm mb-2 flex justify-between">
                                    <span>میان‌وعده</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400" id="snack-calories">0 کالری</span>
                                </h3>
                                <div class="food-items space-y-2">
                                    <div class="text-sm text-gray-500 dark:text-gray-400 text-center empty-message">موردی ثبت نشده است.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Nutrition Analysis -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">تحلیل تغذیه</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-bold text-sm mb-2">نمودار مواد مغذی</h3>
                                <div class="chart-container">
                                    <canvas id="nutrients-chart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-bold text-sm mb-2">توزیع کالری در وعده‌ها</h3>
                                <div class="chart-container">
                                    <canvas id="meals-chart"></canvas>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <div id="nutrition-advice" class="border rounded-md p-3 mt-2 bg-primary-50 dark:bg-primary-900 dark:border-primary-800">
                                    <h3 class="font-bold text-sm mb-2 text-primary-600 dark:text-primary-400">توصیه‌های تغذیه‌ای</h3>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">هنوز دریافت کافی غذا برای تحلیل ثبت نشده است. لطفاً مواد غذایی مصرفی خود را ثبت کنید تا توصیه‌های مناسب دریافت نمایید.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Tab Content -->
        <div id="database-content" class="hidden animate-fadeIn">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">مدیریت پایگاه داده غذاها</h2>
                
                <!-- Food Categories Filter -->
                <div class="mb-4">
                    <label for="food-category-filter" class="block text-sm font-medium mb-1">فیلتر بر اساس دسته‌بندی</label>
                    <select id="food-category-filter" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600">
                        <option value="">همه دسته‌ها</option>
                    </select>
                </div>
                
                <!-- Add New Food Form -->
                <div class="mb-6">
                    <h3 class="font-bold text-sm mb-2">افزودن غذای جدید به پایگاه داده</h3>
                    <div class="border rounded-md p-3 dark:border-gray-700">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                            <div class="col-span-1 sm:col-span-2">
                                <label for="db-food-name" class="block text-xs mb-1">نام غذا</label>
                                <input type="text" id="db-food-name" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="مثال: سالاد مرغ">
                            </div>
                            <div>
                                <label for="db-food-category" class="block text-xs mb-1">دسته‌بندی</label>
                                <select id="db-food-category" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600">
                                    <option value="other">سایر</option>
                                    <option value="grains">غلات</option>
                                    <option value="protein">پروتئین</option>
                                    <option value="vegetables">سبزیجات</option>
                                    <option value="fruits">میوه‌ها</option>
                                    <option value="dairy">لبنیات</option>
                                    <option value="nuts">آجیل</option>
                                    <option value="fats">روغن‌ها</option>
                                    <option value="legumes">حبوبات</option>
                                    <option value="meals">غذاهای اصلی</option>
                                    <option value="soups">سوپ‌ها</option>
                                    <option value="salads">سالادها</option>
                                    <option value="snacks">تنقلات</option>
                                    <option value="sweets">شیرینی‌ها</option>
                                    <option value="desserts">دسرها</option>
                                    <option value="beverages">نوشیدنی‌ها</option>
                                    <option value="fast_food">فست‌فود</option>
                                    <option value="international">غذاهای بین‌المللی</option>
                                    <option value="breakfast">صبحانه</option>
                                </select>
                            </div>
                            <div>
                                <label for="db-food-calories" class="block text-xs mb-1">کالری (کیلوکالری / ۱۰۰ گرم)</label>
                                <input type="number" id="db-food-calories" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0">
                            </div>
                            <div>
                                <label for="db-food-protein" class="block text-xs mb-1">پروتئین (گرم / ۱۰۰ گرم)</label>
                                <input type="number" id="db-food-protein" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0" step="0.1">
                            </div>
                            <div>
                                <label for="db-food-carbs" class="block text-xs mb-1">کربوهیدرات (گرم / ۱۰۰ گرم)</label>
                                <input type="number" id="db-food-carbs" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0" step="0.1">
                            </div>
                            <div>
                                <label for="db-food-fat" class="block text-xs mb-1">چربی (گرم / ۱۰۰ گرم)</label>
                                <input type="number" id="db-food-fat" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0" step="0.1">
                            </div>
                            <div>
                                <label for="db-food-fiber" class="block text-xs mb-1">فیبر (گرم / ۱۰۰ گرم)</label>
                                <input type="number" id="db-food-fiber" class="w-full border rounded-md py-1 px-2 text-base dark:bg-gray-700 dark:border-gray-600" value="0" min="0" step="0.1">
                            </div>
                            <div class="col-span-1 sm:col-span-2">
                                <button id="add-db-food-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md text-sm transition duration-300">افزودن به پایگاه داده</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Search and Filter Foods -->
                <div class="mb-4">
                    <div class="flex flex-col sm:flex-row gap-2 items-center">
                        <div class="flex-grow">
                            <input type="text" id="db-search" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="جستجو در پایگاه داده...">
                        </div>
                        <div class="flex space-x-reverse space-x-2">
                            <button id="clear-search" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 py-2 px-3 rounded-md text-sm transition duration-200">پاک کردن</button>
                            <button id="load-complete-database" class="bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 py-2 px-3 rounded-md text-sm transition duration-200">بارگذاری دیتابیس کامل</button>
                        </div>
                    </div>
                </div>
                
                <!-- Food Database Statistics -->
                <div id="food-stats" class="mb-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-primary-50 dark:bg-primary-900 p-3 rounded-lg">
                        <div class="text-primary-600 dark:text-primary-400 font-bold text-lg" id="total-foods">0</div>
                        <div class="text-xs text-primary-700 dark:text-primary-300">کل غذاها</div>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900 p-3 rounded-lg">
                        <div class="text-green-600 dark:text-green-400 font-bold text-lg" id="public-foods">0</div>
                        <div class="text-xs text-green-700 dark:text-green-300">غذاهای عمومی</div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg">
                        <div class="text-blue-600 dark:text-blue-400 font-bold text-lg" id="user-foods">0</div>
                        <div class="text-xs text-blue-700 dark:text-blue-300">غذاهای شخصی</div>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900 p-3 rounded-lg">
                        <div class="text-yellow-600 dark:text-yellow-400 font-bold text-lg" id="food-categories">0</div>
                        <div class="text-xs text-yellow-700 dark:text-yellow-300">دسته‌بندی</div>
                    </div>
                </div>
                
                <!-- Custom Food Database -->
                <div>
                    <h3 class="font-bold text-sm mb-2">پایگاه داده غذاها</h3>
                    <div class="relative overflow-x-auto rounded-md border dark:border-gray-700">
                        <table class="w-full text-sm text-gray-800 dark:text-gray-200">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-300">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-right force-rtl">نام غذا</th>
                                    <th scope="col" class="px-4 py-3 text-right force-rtl">دسته‌بندی</th>
                                    <th scope="col" class="px-4 py-3 text-right force-rtl">کالری</th>
                                    <th scope="col" class="px-4 py-3 text-right force-rtl">پروتئین</th>
                                    <th scope="col" class="px-4 py-3 text-right force-rtl">کربوهیدرات</th>
                                    <th scope="col" class="px-4 py-3 text-right force-rtl">چربی</th>
                                    <th scope="col" class="px-4 py-3 text-right force-rtl">عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="food-database-table">
                                <!-- Foods will be listed here -->
                                <tr class="border-b dark:border-gray-700" id="empty-foods-message">
                                    <td colspan="7" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">در حال بارگذاری...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="food-pagination" class="flex justify-center mt-4 space-x-reverse space-x-2"></div>
                </div>
            </div>
        </div>

        <!-- Reports Tab Content -->
        <div id="reports-content" class="hidden animate-fadeIn">
            <div class="grid grid-cols-1 gap-4">
                <!-- Date Range Selector -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">انتخاب بازه زمانی</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium mb-1">از تاریخ</label>
                            <input type="date" id="report-start-date" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium mb-1">تا تاریخ</label>
                            <input type="date" id="report-end-date" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div class="flex items-end">
                            <button id="generate-report" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">تولید گزارش</button>
                        </div>
                    </div>
                </div>

                <!-- Nutrient Intake -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">گزارش کالری</h2>
                        <div class="mb-4">
                            <div class="chart-container">
                                <canvas id="weekly-calories-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">گزارش مواد مغذی</h2>
                        <div class="mb-4">
                            <div class="chart-container">
                                <canvas id="weekly-nutrients-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Overview -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">خلاصه آماری</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-primary-50 dark:bg-primary-900 p-4 rounded-lg">
                            <h3 class="text-sm font-bold mb-1 text-primary-800 dark:text-primary-300">میانگین کالری</h3>
                            <div id="avg-calories" class="text-xl font-bold text-primary-600 dark:text-primary-400">0</div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                            <h3 class="text-sm font-bold mb-1 text-blue-800 dark:text-blue-300">میانگین پروتئین</h3>
                            <div id="avg-protein" class="text-xl font-bold text-blue-600 dark:text-blue-400">0g</div>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg">
                            <h3 class="text-sm font-bold mb-1 text-yellow-800 dark:text-yellow-300">میانگین کربوهیدرات</h3>
                            <div id="avg-carbs" class="text-xl font-bold text-yellow-600 dark:text-yellow-400">0g</div>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg">
                            <h3 class="text-sm font-bold mb-1 text-red-800 dark:text-red-300">میانگین چربی</h3>
                            <div id="avg-fat" class="text-xl font-bold text-red-600 dark:text-red-400">0g</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settings-content" class="hidden animate-fadeIn">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">تنظیمات برنامه</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="user-name" class="block text-sm font-medium mb-1">نام کاربر</label>
                            <input type="text" id="user-name" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600" placeholder="نام شما">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">حالت نمایش</label>
                            <div class="flex space-x-reverse space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="theme-mode" value="light" class="form-radio h-4 w-4 text-primary-600">
                                    <span class="mr-2">روشن</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="theme-mode" value="dark" class="form-radio h-4 w-4 text-primary-600">
                                    <span class="mr-2">تیره</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="theme-mode" value="system" class="form-radio h-4 w-4 text-primary-600" checked="">
                                    <span class="mr-2">سیستم</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label for="calorie-precision" class="block text-sm font-medium mb-1">دقت نمایش کالری</label>
                            <select id="calorie-precision" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600">
                                <option value="0">بدون اعشار (1850)</option>
                                <option value="1">یک رقم اعشار (1850.5)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="nutrient-precision" class="block text-sm font-medium mb-1">دقت نمایش مواد مغذی</label>
                            <select id="nutrient-precision" class="w-full border rounded-md py-2 px-3 text-base dark:bg-gray-700 dark:border-gray-600">
                                <option value="0">بدون اعشار (65)</option>
                                <option value="1" selected="">یک رقم اعشار (65.4)</option>
                                <option value="2">دو رقم اعشار (65.42)</option>
                            </select>
                        </div>
                        
                        <div class="pt-2">
                            <button id="save-settings" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">ذخیره تنظیمات</button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">پشتیبان‌گیری و بازیابی</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">می‌توانید از تمام داده‌های برنامه (غذاها، اطلاعات روزانه، اهداف و تنظیمات) پشتیبان بگیرید.</p>
                            
                            <button id="backup-data" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 mb-2">دریافت فایل پشتیبان</button>
                            
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2 mt-4">از فایل پشتیبان خود برای بازیابی اطلاعات استفاده کنید:</p>
                            
                            <button id="restore-data" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">بازیابی از فایل پشتیبان</button>
                        </div>
                        
                        <div class="pt-2 border-t dark:border-gray-700">
                            <h3 class="font-bold text-sm mb-2 text-red-600 dark:text-red-400">حذف داده‌ها</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">با استفاده از گزینه‌های زیر می‌توانید داده‌های برنامه را حذف کنید:</p>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <button id="reset-goals" class="bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 font-medium py-2 px-4 rounded-md transition duration-300 text-sm">بازنشانی اهداف</button>
                                <button id="clear-logs" class="bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 font-medium py-2 px-4 rounded-md transition duration-300 text-sm">حذف گزارش‌ها</button>
                                <button id="reset-foods" class="bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 font-medium py-2 px-4 rounded-md transition duration-300 text-sm">حذف غذاهای شخصی</button>
                                <button id="reset-all" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md transition duration-300 text-sm">حذف همه داده‌ها</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 lg:col-span-2">
                    <h2 class="text-lg font-bold mb-3 text-primary-600 dark:text-primary-400">راهنما</h2>
                    
                    <div class="space-y-3 text-gray-700 dark:text-gray-300 text-sm">
                        <p>به برنامه کالری‌شمار هوشمند خوش آمدید! این برنامه به شما کمک می‌کند تا مصرف کالری و مواد مغذی خود را پیگیری کنید.</p>
                        
                        <div>
                            <h3 class="font-bold mb-1">نحوه استفاده:</h3>
                            <ul class="list-disc list-inside space-y-1 pr-4">
                                <li>در بخش <strong>ثبت روزانه</strong> می‌توانید غذاهای مصرفی روزانه خود را ثبت کنید و مصرف آب را پیگیری نمایید.</li>
                                <li>در بخش <strong>مدیریت غذاها</strong> می‌توانید غذاهای جدیدی را به پایگاه داده اضافه کنید یا آن‌ها را ویرایش نمایید.</li>
                                <li>در بخش <strong>گزارش‌ها</strong> می‌توانید عملکرد خود را بررسی کنید.</li>
                                <li>در بخش <strong>تنظیمات</strong> می‌توانید برنامه را مطابق با نیازهای خود تنظیم کنید و از اطلاعات خود پشتیبان بگیرید.</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h3 class="font-bold mb-1">حالت آنلاین و آفلاین:</h3>
                            <p>برنامه هم در حالت آنلاین (متصل به سرور) و هم در حالت آفلاین (ذخیره محلی) قابل استفاده است. در حالت آنلاین، اطلاعات شما در سرور ذخیره می‌شود و از دستگاه‌های مختلف قابل دسترسی است.</p>
                        </div>
                        
                        <div>
                            <h3 class="font-bold mb-1">پشتیبان‌گیری:</h3>
                            <p>توصیه می‌شود به طور منظم از اطلاعات خود پشتیبان بگیرید. فایل پشتیبان شامل تمام غذاها، اطلاعات روزانه و تنظیمات شما است.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Messages -->
        <div id="error-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 hidden z-50">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative shadow-md animate-shake" role="alert">
                <span id="error-message" class="block"></span>
            </div>
        </div>
        
        <!-- Success Messages -->
        <div id="success-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 hidden z-50">
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative shadow-md animate-scale" role="alert">
                <span id="success-message" class="block"></span>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-10 text-center text-sm text-gray-500 dark:text-gray-400 pb-6">
            <p>کالری‌شمار هوشمند © <span id="current-year"></span></p>
            <p class="text-xs mt-1">نسخه ۲.۰ - سازگار با بک‌اند</p>
        </footer>
    </div>

    <script>
        // ==================== Configuration ====================
        const API_BASE_URL = 'http://localhost:3000/api'; // تغییر دهید به آدرس سرور خود
        const OFFLINE_MODE = false; // برای تست حالت آفلاین true کنید
        
        // ==================== App State ====================
        let appState = {
            // Authentication
            user: null,
            authToken: null,
            isOnline: !OFFLINE_MODE,
            
            // Current state
            currentDate: new Date().toISOString().split('T')[0],
            currentMeal: 'breakfast',
            currentTab: 'tracking',
            selectedFood: null,
            
            // Data
            goals: {
                calories: 2000,
                protein: 80,
                carbs: 250,
                fat: 65,
                water: 2.5
            },
            
            dailyTotals: {
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0,
                fiber: 0,
                water: 0
            },
            
            dailyMeals: {
                breakfast: [],
                lunch: [],
                dinner: [],
                snack: []
            },
            
            foods: [],
            categories: [],
            
            // Settings
            settings: {
                theme: 'system',
                caloriePrecision: 0,
                nutrientPrecision: 1
            }
        };

        // ==================== Utility Functions ====================
        
        // Format number with precision
        function formatNumber(number, precision) {
            return Number(number).toFixed(precision);
        }
        
        // Format calories based on settings
        function formatCalories(calories) {
            return formatNumber(calories, appState.settings.caloriePrecision);
        }
        
        // Format nutrients based on settings
        function formatNutrient(value) {
            return formatNumber(value, appState.settings.nutrientPrecision);
        }
        
        // Get meal name in Farsi
        function getMealNameFarsi(mealType) {
            const mealNames = {
                'breakfast': 'صبحانه',
                'lunch': 'ناهار',
                'dinner': 'شام',
                'snack': 'میان‌وعده'
            };
            return mealNames[mealType] || mealType;
        }
        
        // Show loading overlay
        function showLoading(text = 'در حال بارگذاری...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        // Show message (error or success)
        function showMessage(message, type = 'error') {
            const container = document.getElementById(`${type}-container`);
            const messageEl = document.getElementById(`${type}-message`);
            
            messageEl.textContent = message;
            container.classList.remove('hidden');
            
            setTimeout(() => {
                container.classList.add('hidden');
            }, 4000);
        }
        
        // Show error message
        function showError(message) {
            showMessage(message, 'error');
            console.error('Error:', message);
        }
        
        // Show success message
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        // Show custom confirmation dialog
        function showConfirmDialog(title, message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            const titleEl = document.getElementById('confirm-title');
            const messageEl = document.getElementById('confirm-message');
            const confirmBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            modal.classList.remove('hidden');
            
            // Remove existing event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                onConfirm();
            });
            
            newCancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }

        // ==================== API Functions ====================
        
        // Make API request
        async function apiRequest(endpoint, options = {}) {
            if (!appState.isOnline) {
                throw new Error('در حالت آفلاین امکان ارتباط با سرور وجود ندارد');
            }
            
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(appState.authToken && { 'Authorization': `Bearer ${appState.authToken}` })
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            try {
                const response = await fetch(url, finalOptions);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'خطای ناشناخته رخ داد' }));
                    throw new Error(errorData.error || `خطای HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                if (error.name === 'NetworkError' || error.message.includes('Failed to fetch')) {
                    // Switch to offline mode
                    appState.isOnline = false;
                    updateConnectionStatus();
                    throw new Error('اتصال به سرور برقرار نشد. به حالت آفلاین تغییر کرد.');
                }
                throw error;
            }
        }
        
        // Authentication API calls
        async function loginUser(email, password) {
            const response = await apiRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            return response;
        }
        
        async function registerUser(email, password, name = '') {
            const response = await apiRequest('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ email, password, name })
            });
            return response;
        }
        
        // User API calls
        async function getUserProfile() {
            return await apiRequest('/user/profile');
        }
        
        async function updateUserProfile(data) {
            return await apiRequest('/user/profile', {
                method: 'PUT',
                body: JSON.stringify(data)
            });
        }
        
        async function updateUserGoals(goals) {
            return await apiRequest('/user/goals', {
                method: 'PUT',
                body: JSON.stringify(goals)
            });
        }
        
        // Food API calls
        async function getFoods(search = '', category = '') {
            const params = new URLSearchParams();
            if (search) params.append('search', search);
            if (category) params.append('category', category);
            
            return await apiRequest(`/foods?${params.toString()}`);
        }
        
        async function getFoodCategories() {
            return await apiRequest('/foods/categories');
        }
        
        async function addFood(foodData) {
            return await apiRequest('/foods', {
                method: 'POST',
                body: JSON.stringify(foodData)
            });
        }
        
        async function deleteFood(foodId) {
            return await apiRequest(`/foods/${foodId}`, {
                method: 'DELETE'
            });
        }
        
        async function loadCompleteDatabase() {
            return await apiRequest('/foods/load-complete-database', {
                method: 'POST'
            });
        }
        
        // Daily log API calls
        async function getDailyLog(date) {
            return await apiRequest(`/logs/${date}`);
        }
        
        async function addFoodToMeal(date, mealType, foodData) {
            return await apiRequest(`/logs/${date}/meals/${mealType}`, {
                method: 'POST',
                body: JSON.stringify(foodData)
            });
        }
        
        async function removeFoodFromMeal(date, mealType, itemIndex) {
            return await apiRequest(`/logs/${date}/meals/${mealType}/${itemIndex}`, {
                method: 'DELETE'
            });
        }
        
        async function updateWaterIntake(date, water) {
            return await apiRequest(`/logs/${date}/water`, {
                method: 'PUT',
                body: JSON.stringify({ water })
            });
        }
        
        async function clearDayMeals(date) {
            return await apiRequest(`/logs/${date}/meals`, {
                method: 'DELETE'
            });
        }
        
        // Reports API calls
        async function getWeeklyReport(startDate, endDate) {
            return await apiRequest(`/reports/weekly?startDate=${startDate}&endDate=${endDate}`);
        }
        
        async function getMonthlyStats(year, month) {
            return await apiRequest(`/reports/monthly?year=${year}&month=${month}`);
        }
        
        // Backup API calls
        async function exportBackup() {
            try {
                const response = await fetch(`${API_BASE_URL}/backup/export`, {
                    headers: {
                        'Authorization': `Bearer ${appState.authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('خطا در دریافت فایل پشتیبان');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `calorie_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showSuccess('فایل پشتیبان با موفقیت دانلود شد');
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function importBackup(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(`${API_BASE_URL}/backup/import`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${appState.authToken}`
                },
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'خطا در بازیابی فایل پشتیبان');
            }
            
            return await response.json();
        }

        // ==================== Local Storage Functions ====================
        
        // Save to localStorage (offline mode)
        function saveToLocalStorage() {
            try {
                localStorage.setItem('calorieTracker_state', JSON.stringify({
                    goals: appState.goals,
                    settings: appState.settings,
                    dailyData: {
                        [appState.currentDate]: {
                            totals: appState.dailyTotals,
                            meals: appState.dailyMeals
                        }
                    },
                    foods: appState.foods.filter(food => food.isLocal) // Only save local foods
                }));
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
            }
        }
        
        // Load from localStorage (offline mode)
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('calorieTracker_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    if (data.goals) appState.goals = data.goals;
                    if (data.settings) appState.settings = data.settings;
                    if (data.foods) appState.foods = data.foods;
                    
                    // Load daily data for current date
                    if (data.dailyData && data.dailyData[appState.currentDate]) {
                        const dailyData = data.dailyData[appState.currentDate];
                        appState.dailyTotals = dailyData.totals || appState.dailyTotals;
                        appState.dailyMeals = dailyData.meals || appState.dailyMeals;
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
            }
            return false;
        }
        
        // Export offline data
        function exportOfflineData() {
            try {
                const dataToExport = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    type: 'offline-backup',
                    data: JSON.parse(localStorage.getItem('calorieTracker_state') || '{}')
                };
                
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `calorie_tracker_offline_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showSuccess('فایل پشتیبان آفلاین با موفقیت ایجاد شد');
            } catch (error) {
                showError('خطا در ایجاد فایل پشتیبان');
            }
        }

        // ==================== Data Management Functions ====================
        
        // Update connection status
        function updateConnectionStatus() {
            const onlineStatus = document.getElementById('online-status');
            const offlineStatus = document.getElementById('offline-status');
            const syncBtn = document.getElementById('sync-btn');
            
            if (appState.isOnline) {
                onlineStatus.classList.remove('hidden');
                offlineStatus.classList.add('hidden');
                syncBtn.classList.add('hidden');
            } else {
                onlineStatus.classList.add('hidden');
                offlineStatus.classList.remove('hidden');
                syncBtn.classList.remove('hidden');
            }
        }
        
        // Calculate totals from meals
        function calculateTotals() {
            const totals = {
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0,
                fiber: 0,
                water: appState.dailyTotals.water || 0
            };
            
            Object.values(appState.dailyMeals).forEach(meal => {
                meal.forEach(item => {
                    totals.calories += item.calories || 0;
                    totals.protein += item.protein || 0;
                    totals.carbs += item.carbs || 0;
                    totals.fat += item.fat || 0;
                    totals.fiber += item.fiber || 0;
                });
            });
            
            appState.dailyTotals = totals;
        }
        
        // Load daily data (from API or localStorage)
        async function loadDailyData(date = appState.currentDate) {
            try {
                if (appState.isOnline && appState.authToken) {
                    showLoading('بارگذاری اطلاعات روز...');
                    const data = await getDailyLog(date);
                    
                    appState.dailyTotals = data.totals || {
                        calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0, water: 0
                    };
                    appState.dailyMeals = data.meals || {
                        breakfast: [], lunch: [], dinner: [], snack: []
                    };
                } else {
                    // Load from localStorage in offline mode
                    loadFromLocalStorage();
                }
                
                updateAllUI();
            } catch (error) {
                showError('خطا در بارگذاری اطلاعات روز: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Load foods data
        async function loadFoods(search = '', category = '') {
            try {
                if (appState.isOnline && appState.authToken) {
                    document.getElementById('search-loading').classList.remove('hidden');
                    const foods = await getFoods(search, category);
                    appState.foods = foods;
                } else {
                    // Filter local foods
                    let foods = appState.foods;
                    if (search) {
                        foods = foods.filter(food => 
                            food.name.toLowerCase().includes(search.toLowerCase())
                        );
                    }
                    if (category) {
                        foods = foods.filter(food => food.category === category);
                    }
                    return foods;
                }
                
                return appState.foods;
            } catch (error) {
                showError('خطا در بارگذاری غذاها: ' + error.message);
                return [];
            } finally {
                document.getElementById('search-loading').classList.add('hidden');
            }
        }
        
        // Load food categories
        async function loadCategories() {
            try {
                if (appState.isOnline && appState.authToken) {
                    const categories = await getFoodCategories();
                    appState.categories = categories;
                } else {
                    // Generate categories from local foods
                    const categorySet = new Set(appState.foods.map(food => food.category));
                    appState.categories = Array.from(categorySet).map(cat => ({
                        value: cat,
                        label: getCategoryLabel(cat)
                    }));
                }
                
                updateCategoriesUI();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // Get category label in Farsi
        function getCategoryLabel(category) {
            const categoryMap = {
                'grains': 'غلات',
                'protein': 'پروتئین',
                'vegetables': 'سبزیجات',
                'fruits': 'میوه‌ها',
                'dairy': 'لبنیات',
                'nuts': 'آجیل',
                'fats': 'روغن‌ها',
                'legumes': 'حبوبات',
                'meals': 'غذاهای اصلی',
                'soups': 'سوپ‌ها',
                'salads': 'سالادها',
                'snacks': 'تنقلات',
                'sweets': 'شیرینی‌ها',
                'desserts': 'دسرها',
                'beverages': 'نوشیدنی‌ها',
                'fast_food': 'فست‌فود',
                'international': 'غذاهای بین‌المللی',
                'breakfast': 'صبحانه',
                'herbs': 'سبزیجات معطر',
                'spices': 'ادویه‌ها',
                'sauces': 'سس‌ها',
                'pickles': 'ترشیجات',
                'other': 'سایر'
            };
            return categoryMap[category] || category;
        }

        // ==================== UI Update Functions ====================
        
        // Update all UI components
        function updateAllUI() {
            updateSummaryDisplay();
            updateFoodLogDisplay();
            updateChartsData();
            updateNutritionAdvice();
            updateGoalsInputs();
            updateThemeUI();
            
            if (appState.currentTab === 'database') {
                updateFoodDatabaseTable();
            }
        }
        
        // Update summary display
        function updateSummaryDisplay() {
            const totals = appState.dailyTotals;
            const goals = appState.goals;
            
            // Update text displays
            document.getElementById('calorie-summary').textContent = 
                `${formatCalories(totals.calories)} / ${formatCalories(goals.calories)} کیلوکالری`;
            
            document.getElementById('protein-summary').textContent = 
                `${formatNutrient(totals.protein)} / ${formatNutrient(goals.protein)} گرم`;
            
            document.getElementById('carbs-summary').textContent = 
                `${formatNutrient(totals.carbs)} / ${formatNutrient(goals.carbs)} گرم`;
            
            document.getElementById('fat-summary').textContent = 
                `${formatNutrient(totals.fat)} / ${formatNutrient(goals.fat)} گرم`;
            
            document.getElementById('water-summary').textContent = 
                `${formatNutrient(totals.water)} / ${formatNutrient(goals.water)} لیتر`;
            
            // Update progress bars
            const caloriePercent = Math.min(100, (totals.calories / (goals.calories || 1)) * 100);
            const proteinPercent = Math.min(100, (totals.protein / (goals.protein || 1)) * 100);
            const carbsPercent = Math.min(100, (totals.carbs / (goals.carbs || 1)) * 100);
            const fatPercent = Math.min(100, (totals.fat / (goals.fat || 1)) * 100);
            const waterPercent = Math.min(100, (totals.water / (goals.water || 1)) * 100);
            
            document.getElementById('calorie-progress').style.width = `${caloriePercent}%`;
            document.getElementById('protein-progress').style.width = `${proteinPercent}%`;
            document.getElementById('carbs-progress').style.width = `${carbsPercent}%`;
            document.getElementById('fat-progress').style.width = `${fatPercent}%`;
            document.getElementById('water-progress').style.width = `${waterPercent}%`;
            
            // Update macro percentages
            const macroPercentages = calculateMacroPercentages(totals);
            document.getElementById('protein-percent').textContent = `${macroPercentages.protein}%`;
            document.getElementById('carbs-percent').textContent = `${macroPercentages.carbs}%`;
            document.getElementById('fat-percent').textContent = `${macroPercentages.fat}%`;
            
            // Update meal calories
            const mealCalories = {
                breakfast: 0,
                lunch: 0,
                dinner: 0,
                snack: 0
            };
            
            Object.keys(appState.dailyMeals).forEach(mealType => {
                appState.dailyMeals[mealType].forEach(item => {
                    mealCalories[mealType] += item.calories;
                });
                document.getElementById(`${mealType}-calories`).textContent = 
                    `${formatCalories(mealCalories[mealType])} کالری`;
            });
        }
        
        // Calculate macro percentages
        function calculateMacroPercentages(totals) {
            const totalCalories = totals.calories;
            
            if (totalCalories === 0) {
                return { protein: 0, carbs: 0, fat: 0 };
            }
            
            const proteinCalories = totals.protein * 4;
            const carbsCalories = totals.carbs * 4;
            const fatCalories = totals.fat * 9;
            
            return {
                protein: Math.round((proteinCalories / totalCalories) * 100),
                carbs: Math.round((carbsCalories / totalCalories) * 100),
                fat: Math.round((fatCalories / totalCalories) * 100)
            };
        }
        
        // Update food log display
        function updateFoodLogDisplay() {
            Object.keys(appState.dailyMeals).forEach(mealType => {
                const mealContainer = document.querySelector(`#${mealType}-log .food-items`);
                const mealItems = appState.dailyMeals[mealType];
                
                mealContainer.innerHTML = '';
                
                if (mealItems.length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'text-sm text-gray-500 dark:text-gray-400 text-center empty-message';
                    emptyMessage.textContent = 'موردی ثبت نشده است.';
                    mealContainer.appendChild(emptyMessage);
                    return;
                }
                
                mealItems.forEach((item, index) => {
                    const foodItem = document.createElement('div');
                    foodItem.className = 'food-log-item flex justify-between items-center text-sm p-2 bg-gray-50 dark:bg-gray-700 rounded animate-scale';
                    
                    foodItem.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${item.amount}g</div>
                        </div>
                        <div class="ml-2 text-right">
                            <div class="font-medium">${formatCalories(item.calories)} کالری</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                پ: ${formatNutrient(item.protein)}g | ک: ${formatNutrient(item.carbs)}g | چ: ${formatNutrient(item.fat)}g
                            </div>
                        </div>
                        <button class="delete-food ml-2 text-red-500 hover:text-red-700 transition duration-150" data-meal="${mealType}" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;
                    
                    mealContainer.appendChild(foodItem);
                    
                    // Add delete handler
                    foodItem.querySelector('.delete-food').addEventListener('click', async function() {
                        const mealType = this.dataset.meal;
                        const index = parseInt(this.dataset.index);
                        
                        await deleteFoodFromMeal(mealType, index);
                    });
                });
            });
        }
        
        // Update goals inputs
        function updateGoalsInputs() {
            document.getElementById('calorie-goal').value = appState.goals.calories || '';
            document.getElementById('protein-goal').value = appState.goals.protein || '';
            document.getElementById('carbs-goal').value = appState.goals.carbs || '';
            document.getElementById('fat-goal').value = appState.goals.fat || '';
            document.getElementById('water-goal').value = appState.goals.water || '';
        }
        
        // Update theme UI
        function updateThemeUI() {
            const themeMode = appState.settings.theme;
            const isDark = themeMode === 'dark' || 
                          (themeMode === 'system' && 
                           window.matchMedia && 
                           window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // Update radio buttons in settings
            const radioButtons = document.querySelectorAll('input[name="theme-mode"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value === themeMode;
            });
        }
        
        // Update categories UI
        function updateCategoriesUI() {
            const filterSelect = document.getElementById('food-category-filter');
            const addSelect = document.getElementById('db-food-category');
            
            // Update filter dropdown
            filterSelect.innerHTML = '<option value="">همه دسته‌ها</option>';
            appState.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.value;
                option.textContent = category.label;
                filterSelect.appendChild(option);
            });
        }
        
        // Update food database table
        async function updateFoodDatabaseTable(searchQuery = '', category = '') {
            const tableBody = document.getElementById('food-database-table');
            const emptyMessage = document.getElementById('empty-foods-message');
            
            try {
                showLoading('بارگذاری غذاها...');
                
                const foods = await loadFoods(searchQuery, category);
                
                // Clear existing rows
                tableBody.innerHTML = '';
                
                if (foods.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">موردی یافت نشد.</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                // Update statistics
                updateFoodDatabaseStats(foods);
                
                // Add food rows (with pagination)
                const itemsPerPage = 20;
                const totalPages = Math.ceil(foods.length / itemsPerPage);
                const currentPage = 1; // Implement pagination if needed
                
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, foods.length);
                const displayFoods = foods.slice(startIndex, endIndex);
                
                displayFoods.forEach((food, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3">${food.name}</td>
                        <td class="px-4 py-3">${getCategoryLabel(food.category || 'other')}</td>
                        <td class="px-4 py-3">${formatCalories(food.calories)} kcal</td>
                        <td class="px-4 py-3">${formatNutrient(food.protein)}g</td>
                        <td class="px-4 py-3">${formatNutrient(food.carbs)}g</td>
                        <td class="px-4 py-3">${formatNutrient(food.fat)}g</td>
                        <td class="px-4 py-3">
                            ${food.createdBy ? `
                                <button class="delete-food-db text-red-500 hover:text-red-700 transition duration-150" data-food-id="${food._id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            ` : `
                                <span class="text-xs text-gray-500">عمومی</span>
                            `}
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                    
                    // Add delete handler for user foods
                    const deleteBtn = row.querySelector('.delete-food-db');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', async function() {
                            const foodId = this.dataset.foodId;
                            await deleteFoodFromDatabase(foodId, food.name);
                        });
                    }
                });
                
            } catch (error) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="px-4 py-4 text-center text-red-500">خطا در بارگذاری: ${error.message}</td>`;
                tableBody.appendChild(row);
            } finally {
                hideLoading();
            }
        }
        
        // Update food database statistics
        function updateFoodDatabaseStats(foods) {
            const totalFoods = foods.length;
            const publicFoods = foods.filter(food => food.isPublic || !food.createdBy).length;
            const userFoods = foods.filter(food => food.createdBy && !food.isPublic).length;
            const categories = new Set(foods.map(food => food.category || 'other')).size;
            
            document.getElementById('total-foods').textContent = totalFoods;
            document.getElementById('public-foods').textContent = publicFoods;
            document.getElementById('user-foods').textContent = userFoods;
            document.getElementById('food-categories').textContent = categories;
        }

        // ==================== Chart Functions ====================
        
        // Initialize charts
        let macrosChart, nutrientsChart, mealsChart, weeklyCaloriesChart, weeklyNutrientsChart;
        
        function initializeCharts() {
            Chart.defaults.font.family = 'Vazirmatn, sans-serif';
            
            // Macros Pie Chart
            const macrosCtx = document.getElementById('macros-chart').getContext('2d');
            macrosChart = new Chart(macrosCtx, {
                type: 'doughnut',
                data: {
                    labels: ['پروتئین', 'کربوهیدرات', 'چربی'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(255, 99, 132, 0.6)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    }
                }
            });
            
            // Nutrients Bar Chart
            const nutrientsCtx = document.getElementById('nutrients-chart').getContext('2d');
            nutrientsChart = new Chart(nutrientsCtx, {
                type: 'bar',
                data: {
                    labels: ['پروتئین', 'کربوهیدرات', 'چربی', 'فیبر'],
                    datasets: [{
                        label: 'گرم',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(75, 192, 192, 0.6)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Meals Doughnut Chart
            const mealsCtx = document.getElementById('meals-chart').getContext('2d');
            mealsChart = new Chart(mealsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['صبحانه', 'ناهار', 'شام', 'میان‌وعده'],
                    datasets: [{
                        label: 'کالری',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.6)',
                            'rgba(52, 211, 153, 0.6)',
                            'rgba(251, 146, 60, 0.6)',
                            'rgba(129, 140, 248, 0.6)'
                        ],
                        borderColor: [
                            'rgba(99, 102, 241, 1)',
                            'rgba(52, 211, 153, 1)',
                            'rgba(251, 146, 60, 1)',
                            'rgba(129, 140, 248, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    }
                }
            });
            
            // Weekly Calories Chart
            const weeklyCaloriesCtx = document.getElementById('weekly-calories-chart').getContext('2d');
            weeklyCaloriesChart = new Chart(weeklyCaloriesCtx, {
                type: 'bar',
                data: {
                    labels: ['کالری امروز'],
                    datasets: [{
                        label: 'کالری دریافتی',
                        data: [0],
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'هدف کالری',
                        data: [0],
                        backgroundColor: 'rgba(156, 163, 175, 0.5)',
                        borderColor: 'rgba(156, 163, 175, 0.8)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'کالری (کیلوکالری)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    }
                }
            });
            
            // Weekly Nutrients Chart
            const weeklyNutrientsCtx = document.getElementById('weekly-nutrients-chart').getContext('2d');
            weeklyNutrientsChart = new Chart(weeklyNutrientsCtx, {
                type: 'bar',
                data: {
                    labels: ['پروتئین', 'کربوهیدرات', 'چربی'],
                    datasets: [{
                        label: 'مقدار (گرم)',
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(255, 99, 132, 0.6)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'گرم'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Update charts with current data
        function updateChartsData() {
            if (!nutrientsChart || !mealsChart || !macrosChart) return;
            
            const totals = appState.dailyTotals;
            
            // Update macros chart
            const proteinCalories = totals.protein * 4;
            const carbsCalories = totals.carbs * 4;
            const fatCalories = totals.fat * 9;
            
            macrosChart.data.datasets[0].data = [proteinCalories, carbsCalories, fatCalories];
            macrosChart.update('none');
            
            // Update nutrients chart
            nutrientsChart.data.datasets[0].data = [totals.protein, totals.carbs, totals.fat, totals.fiber];
            nutrientsChart.update('none');
            
            // Update meals chart
            const mealCalories = {
                breakfast: 0,
                lunch: 0,
                dinner: 0,
                snack: 0
            };
            
            Object.keys(appState.dailyMeals).forEach(mealType => {
                appState.dailyMeals[mealType].forEach(item => {
                    mealCalories[mealType] += item.calories;
                });
            });
            
            mealsChart.data.datasets[0].data = [
                mealCalories.breakfast,
                mealCalories.lunch,
                mealCalories.dinner,
                mealCalories.snack
            ];
            mealsChart.update('none');
            
            // Update weekly/summary charts
            weeklyCaloriesChart.data.datasets[0].data = [totals.calories];
            weeklyCaloriesChart.data.datasets[1].data = [appState.goals.calories];
            weeklyCaloriesChart.update('none');
            
            weeklyNutrientsChart.data.datasets[0].data = [totals.protein, totals.carbs, totals.fat];
            weeklyNutrientsChart.update('none');
        }
        
        // Update nutrition advice
        function updateNutritionAdvice() {
            const adviceContainer = document.getElementById('nutrition-advice');
            let advice = '<h3 class="font-bold text-sm mb-2 text-primary-600 dark:text-primary-400">توصیه‌های تغذیه‌ای</h3>';
            
            const totals = appState.dailyTotals;
            
            if (totals.calories === 0) {
                advice += '<p class="text-sm text-gray-700 dark:text-gray-300">هنوز دریافت کافی غذا برای تحلیل ثبت نشده است. لطفاً مواد غذایی مصرفی خود را ثبت کنید تا توصیه‌های مناسب دریافت نمایید.</p>';
                adviceContainer.innerHTML = advice;
                return;
            }
            
            const adviceList = [];
            
            // Generate personalized advice based on current intake
            const proteinPercent = (totals.protein * 4 / (totals.calories || 1)) * 100;
            const carbPercent = (totals.carbs * 4 / (totals.calories || 1)) * 100;
            const fatPercent = (totals.fat * 9 / (totals.calories || 1)) * 100;
            
            if (proteinPercent < 10) {
                adviceList.push('درصد پروتئین دریافتی شما کم است. منابع پروتئینی مانند مرغ، ماهی، تخم مرغ و حبوبات را افزایش دهید.');
            } else if (proteinPercent > 30) {
                adviceList.push('درصد پروتئین دریافتی شما بالاست. تعادل بیشتری بین درشت مغذی‌ها ایجاد کنید.');
            }
            
            if (carbPercent < 40) {
                adviceList.push('درصد کربوهیدرات دریافتی شما کم است. منابع کربوهیدرات سالم مانند غلات کامل را افزایش دهید.');
            } else if (carbPercent > 65) {
                adviceList.push('درصد کربوهیدرات دریافتی شما بالاست. تعادل بیشتری بین درشت مغذی‌ها ایجاد کنید.');
            }
            
            if (fatPercent < 20) {
                adviceList.push('درصد چربی دریافتی شما کم است. چربی‌های سالم مانند روغن زیتون، آووکادو و مغزها را افزایش دهید.');
            } else if (fatPercent > 35) {
                adviceList.push('درصد چربی دریافتی شما بالاست. چربی‌های اشباع شده را کاهش داده و بیشتر از منابع چربی غیراشباع استفاده کنید.');
            }
            
            if (totals.fiber < 25) {
                adviceList.push('دریافت فیبر شما کمتر از حد توصیه شده است. میوه‌ها، سبزیجات و غلات کامل بیشتری مصرف کنید.');
            }
            
            if (totals.water < appState.goals.water * 0.7) {
                adviceList.push('دریافت آب شما کمتر از مقدار توصیه شده است. به‌طور منظم آب بنوشید.');
            }
            
            const calorieDiff = totals.calories - appState.goals.calories;
            if (calorieDiff > 300) {
                adviceList.push(`شما ${Math.round(calorieDiff)} کالری بیشتر از هدف روزانه خود دریافت کرده‌اید.`);
            } else if (calorieDiff < -300 && totals.calories > 0) {
                adviceList.push(`شما ${Math.abs(Math.round(calorieDiff))} کالری کمتر از هدف روزانه خود دریافت کرده‌اید.`);
            }
            
            if (adviceList.length > 0) {
                advice += '<ul class="text-sm text-gray-700 dark:text-gray-300 list-disc list-inside space-y-1">';
                adviceList.forEach(item => {
                    advice += `<li>${item}</li>`;
                });
                advice += '</ul>';
            } else {
                advice += '<p class="text-sm text-gray-700 dark:text-gray-300">با توجه به اطلاعات ثبت شده، الگوی تغذیه شما متعادل به نظر می‌رسد. ادامه دهید!</p>';
            }
            
            adviceContainer.innerHTML = advice;
        }

        // ==================== Event Handlers ====================
        
        // Add food to meal
        async function addFoodToCurrentMeal(foodData) {
            try {
                if (appState.isOnline && appState.authToken) {
                    await addFoodToMeal(appState.currentDate, appState.currentMeal, foodData);
                } else {
                    // Add to local storage in offline mode
                    appState.dailyMeals[appState.currentMeal].push(foodData);
                    calculateTotals();
                    saveToLocalStorage();
                }
                
                updateAllUI();
                showSuccess(`${foodData.name} به ${getMealNameFarsi(appState.currentMeal)} اضافه شد`);
            } catch (error) {
                showError('خطا در افزودن غذا: ' + error.message);
            }
        }
        
        // Delete food from meal
        async function deleteFoodFromMeal(mealType, index) {
            try {
                if (appState.isOnline && appState.authToken) {
                    await removeFoodFromMeal(appState.currentDate, mealType, index);
                } else {
                    // Remove from local storage in offline mode
                    appState.dailyMeals[mealType].splice(index, 1);
                    calculateTotals();
                    saveToLocalStorage();
                }
                
                updateAllUI();
                showSuccess('غذا با موفقیت حذف شد');
            } catch (error) {
                showError('خطا در حذف غذا: ' + error.message);
            }
        }
        
        // Add food to database
        async function addFoodToDatabase(foodData) {
            try {
                if (appState.isOnline && appState.authToken) {
                    await addFood(foodData);
                } else {
                    // Add to local foods with isLocal flag
                    foodData.isLocal = true;
                    foodData._id = Date.now().toString();
                    appState.foods.push(foodData);
                    saveToLocalStorage();
                }
                
                showSuccess(`غذای "${foodData.name}" با موفقیت در پایگاه داده ذخیره شد`);
                
                if (appState.currentTab === 'database') {
                    updateFoodDatabaseTable();
                }
            } catch (error) {
                showError('خطا در افزودن غذا به پایگاه داده: ' + error.message);
            }
        }
        
        // Delete food from database
        async function deleteFoodFromDatabase(foodId, foodName) {
            showConfirmDialog(
                'حذف غذا',
                `آیا از حذف "${foodName}" اطمینان دارید؟`,
                async () => {
                    try {
                        if (appState.isOnline && appState.authToken) {
                            await deleteFood(foodId);
                        } else {
                            // Remove from local foods
                            const index = appState.foods.findIndex(food => food._id === foodId);
                            if (index !== -1) {
                                appState.foods.splice(index, 1);
                                saveToLocalStorage();
                            }
                        }
                        
                        showSuccess('غذا با موفقیت حذف شد');
                        updateFoodDatabaseTable();
                    } catch (error) {
                        showError('خطا در حذف غذا: ' + error.message);
                    }
                }
            );
        }
        
        // Update goals
        async function updateGoals() {
            const calories = parseFloat(document.getElementById('calorie-goal').value);
            const protein = parseFloat(document.getElementById('protein-goal').value);
            const carbs = parseFloat(document.getElementById('carbs-goal').value);
            const fat = parseFloat(document.getElementById('fat-goal').value);
            const water = parseFloat(document.getElementById('water-goal').value);
            
            if (isNaN(calories) || calories < 500 || calories > 10000) {
                showError('هدف کالری باید بین ۵۰۰ تا ۱۰۰۰۰ کیلوکالری باشد');
                return;
            }
            
            const newGoals = { calories, protein, carbs, fat, water };
            
            try {
                if (appState.isOnline && appState.authToken) {
                    await updateUserGoals(newGoals);
                }
                
                appState.goals = newGoals;
                
                if (!appState.isOnline) {
                    saveToLocalStorage();
                }
                
                updateAllUI();
                showSuccess('اهداف با موفقیت به‌روزرسانی شد');
            } catch (error) {
                showError('خطا در به‌روزرسانی اهداف: ' + error.message);
            }
        }
        
        // Update water intake
        async function updateWater(amount) {
            const newWaterAmount = Math.max(0, appState.dailyTotals.water + amount);
            
            try {
                if (appState.isOnline && appState.authToken) {
                    await updateWaterIntake(appState.currentDate, newWaterAmount);
                } else {
                    appState.dailyTotals.water = newWaterAmount;
                    saveToLocalStorage();
                }
                
                updateSummaryDisplay();
                
                if (amount > 0) {
                    showSuccess(`${Math.abs(amount * 1000)} میلی‌لیتر آب اضافه شد`);
                } else {
                    showSuccess('مقدار آب مصرفی بازنشانی شد');
                }
            } catch (error) {
                showError('خطا در به‌روزرسانی آب: ' + error.message);
            }
        }

        // ==================== Authentication Functions ====================
        
        // Show login modal
        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
        }
        
        // Hide login modal
        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }
        
        // Handle login
        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.textContent = 'لطفاً ایمیل و رمز عبور را وارد کنید';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                showLoading('در حال ورود...');
                const response = await loginUser(email, password);
                
                appState.authToken = response.token;
                appState.user = response.user;
                appState.isOnline = true;
                
                // Save auth token
                localStorage.setItem('authToken', response.token);
                
                hideLoginModal();
                hideLoading();
                
                // Load user data
                await initializeApp();
                
                showSuccess(`خوش آمدید ${response.user.name || 'کاربر گرامی'}!`);
                
            } catch (error) {
                hideLoading();
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }
        
        // Handle register
        async function handleRegister() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const errorDiv = document.getElementById('register-error');
            
            if (!email || !password) {
                errorDiv.textContent = 'لطفاً ایمیل و رمز عبور را وارد کنید';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'رمز عبور باید حداقل ۶ کاراکتر باشد';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                showLoading('در حال ثبت نام...');
                const response = await registerUser(email, password, name);
                
                appState.authToken = response.token;
                appState.user = response.user;
                appState.isOnline = true;
                
                // Save auth token
                localStorage.setItem('authToken', response.token);
                
                hideLoginModal();
                hideLoading();
                
                // Show onboarding
                document.getElementById('onboarding-modal').classList.remove('hidden');
                
                showSuccess('ثبت نام با موفقیت انجام شد!');
                
            } catch (error) {
                hideLoading();
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }
        
        // Handle logout
        function handleLogout() {
            showConfirmDialog(
                'خروج از حساب کاربری',
                'آیا از خروج از حساب کاربری اطمینان دارید؟',
                () => {
                    appState.authToken = null;
                    appState.user = null;
                    appState.isOnline = false;
                    
                    localStorage.removeItem('authToken');
                    
                    // Reset to offline mode
                    showLoginModal();
                    updateConnectionStatus();
                    
                    showSuccess('با موفقیت خارج شدید');
                }
            );
        }
        
        // Check authentication on startup
        function checkAuthentication() {
            const savedToken = localStorage.getItem('authToken');
            
            if (savedToken && !OFFLINE_MODE) {
                appState.authToken = savedToken;
                appState.isOnline = true;
                return true;
            }
            
            return false;
        }

        // ==================== Setup Functions ====================
        
        // Setup event listeners
        function setupEventListeners() {
            // Current date selector
            document.getElementById('current-date').addEventListener('change', function() {
                appState.currentDate = this.value;
                loadDailyData(appState.currentDate);
            });
            
            // Tab navigation
            setupTabs();
            
            // Meal type selection
            setupMealTypeButtons();
            
            // Food search and add
            setupFoodSearch();
            setupAddButtons();
            
            // Goals management
            document.getElementById('update-goals').addEventListener('click', updateGoals);
            
            // Water management
            document.getElementById('add-water').addEventListener('click', () => updateWater(0.25));
            document.getElementById('reset-water').addEventListener('click', () => {
                showConfirmDialog(
                    'بازنشانی آب',
                    'آیا از بازنشانی مقدار آب مصرفی اطمینان دارید؟',
                    () => {
                        appState.dailyTotals.water = 0;
                        updateWater(0);
                    }
                );
            });
            
            // Clear day log
            document.getElementById('clear-day-log').addEventListener('click', () => {
                showConfirmDialog(
                    'پاک کردن اطلاعات',
                    'آیا از پاک کردن تمام اطلاعات غذایی اطمینان دارید؟',
                    async () => {
                        try {
                            if (appState.isOnline && appState.authToken) {
                                await clearDayMeals(appState.currentDate);
                            } else {
                                appState.dailyMeals = {
                                    breakfast: [], lunch: [], dinner: [], snack: []
                                };
                                calculateTotals();
                                saveToLocalStorage();
                            }
                            
                            updateAllUI();
                            showSuccess('اطلاعات غذایی پاک شد');
                        } catch (error) {
                            showError('خطا در پاک کردن اطلاعات: ' + error.message);
                        }
                    }
                );
            });
            
            // Database management
            setupDatabaseManagement();
            
            // Settings
            setupSettings();
            
            // Authentication
            setupAuthentication();
            
            // Backup/Restore
            setupBackupRestore();
            
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                if (appState.settings.theme === 'system') {
                    appState.settings.theme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                } else {
                    appState.settings.theme = appState.settings.theme === 'dark' ? 'light' : 'dark';
                }
                
                updateThemeUI();
                saveToLocalStorage();
            });
        }
        
        // Setup tabs
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab');
            const tabContents = {
                'tracking': document.getElementById('tracking-content'),
                'database': document.getElementById('database-content'),
                'reports': document.getElementById('reports-content'),
                'settings': document.getElementById('settings-content')
            };
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.id.replace('tab-', '');
                    
                    // Update active tab
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active-tab', 'text-primary-600', 'dark:text-primary-400');
                        btn.classList.add('text-gray-500', 'dark:text-gray-400');
                    });
                    
                    // Hide all tab contents
                    Object.values(tabContents).forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show selected tab
                    this.classList.add('active-tab', 'text-primary-600', 'dark:text-primary-400');
                    this.classList.remove('text-gray-500', 'dark:text-gray-400');
                    tabContents[tabId].classList.remove('hidden');
                    
                    appState.currentTab = tabId;
                    
                    // Tab-specific actions
                    if (tabId === 'database') {
                        updateFoodDatabaseTable();
                        loadCategories();
                    } else if (tabId === 'settings') {
                        updateSettingsUI();
                    }
                });
            });
        }
        
        // Setup meal type buttons
        function setupMealTypeButtons() {
            const mealButtons = document.querySelectorAll('.meal-type-btn');
            
            mealButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Update active meal button
                    mealButtons.forEach(btn => {
                        btn.classList.remove('bg-primary-100', 'dark:bg-primary-900', 'text-primary-600', 'dark:text-primary-300');
                        btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-400');
                    });
                    
                    this.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-400');
                    this.classList.add('bg-primary-100', 'dark:bg-primary-900', 'text-primary-600', 'dark:text-primary-300');
                    
                    appState.currentMeal = this.dataset.meal;
                });
            });
        }
        
        // Setup food search
        function setupFoodSearch() {
            const searchInput = document.getElementById('food-search');
            const searchResults = document.getElementById('search-results');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    await displaySearchResults(query);
                }, 300);
            });
            
            searchInput.addEventListener('focus', async function() {
                if (this.value.trim().length >= 2) {
                    await displaySearchResults(this.value.trim());
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }
        
        // Display search results
        async function displaySearchResults(query) {
            const searchResults = document.getElementById('search-results');
            
            try {
                const foods = await loadFoods(query);
                
                searchResults.innerHTML = '';
                
                if (foods.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'py-2 px-3 text-sm text-gray-500 dark:text-gray-400';
                    noResults.textContent = 'موردی یافت نشد';
                    searchResults.appendChild(noResults);
                } else {
                    foods.slice(0, 8).forEach(food => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'food-item py-2 px-3 border-b dark:border-gray-700 last:border-0 transition-colors duration-150';
                        
                        resultItem.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium">${food.name}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${formatCalories(food.calories)} کالری / ۱۰۰ گرم</span>
                            </div>
                            <div class="flex text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <span class="ml-2">پروتئین: ${formatNutrient(food.protein)}g</span>
                                <span class="ml-2">کربو: ${formatNutrient(food.carbs)}g</span>
                                <span>چربی: ${formatNutrient(food.fat)}g</span>
                            </div>
                        `;
                        
                        resultItem.addEventListener('click', () => selectFood(food));
                        searchResults.appendChild(resultItem);
                    });
                }
                
                searchResults.classList.remove('hidden');
            } catch (error) {
                console.error('Error searching foods:', error);
            }
        }
        
        // Select food for adding
        function selectFood(food) {
            appState.selectedFood = food;
            
            document.getElementById('selected-food-name').textContent = food.name;
            document.getElementById('selected-food-calories').textContent = `${formatCalories(food.calories)} کالری / ۱۰۰ گرم`;
            document.getElementById('selected-food-protein').textContent = `${formatNutrient(food.protein)}g`;
            document.getElementById('selected-food-carbs').textContent = `${formatNutrient(food.carbs)}g`;
            document.getElementById('selected-food-fat').textContent = `${formatNutrient(food.fat)}g`;
            document.getElementById('selected-food-fiber').textContent = `${formatNutrient(food.fiber || 0)}g`;
            
            document.getElementById('selected-food').classList.remove('hidden');
            document.getElementById('custom-food').classList.add('hidden');
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('food-search').value = food.name;
        }
        
        // Setup add buttons
        function setupAddButtons() {
            // Add selected food
            document.getElementById('add-food-btn').addEventListener('click', async function() {
                if (!appState.selectedFood) {
                    showError('لطفاً ابتدا یک غذا انتخاب کنید');
                    return;
                }
                
                const amount = parseFloat(document.getElementById('food-amount').value);
                
                if (isNaN(amount) || amount <= 0) {
                    showError('لطفاً مقدار معتبری وارد کنید');
                    return;
                }
                
                const ratio = amount / 100;
                const foodEntry = {
                    name: appState.selectedFood.name,
                    amount: amount,
                    calories: Math.round(appState.selectedFood.calories * ratio),
                    protein: parseFloat((appState.selectedFood.protein * ratio).toFixed(1)),
                    carbs: parseFloat((appState.selectedFood.carbs * ratio).toFixed(1)),
                    fat: parseFloat((appState.selectedFood.fat * ratio).toFixed(1)),
                    fiber: parseFloat(((appState.selectedFood.fiber || 0) * ratio).toFixed(1))
                };
                
                await addFoodToCurrentMeal(foodEntry);
                
                // Reset selection
                document.getElementById('selected-food').classList.add('hidden');
                document.getElementById('custom-food').classList.remove('hidden');
                document.getElementById('food-search').value = '';
                appState.selectedFood = null;
            });
            
            // Add custom food to meal
            document.getElementById('add-custom-food-btn').addEventListener('click', async function() {
                const name = document.getElementById('custom-food-name').value.trim();
                const amount = parseFloat(document.getElementById('custom-food-amount').value);
                const calories = parseFloat(document.getElementById('custom-food-calories').value);
                const protein = parseFloat(document.getElementById('custom-food-protein').value) || 0;
                const carbs = parseFloat(document.getElementById('custom-food-carbs').value) || 0;
                const fat = parseFloat(document.getElementById('custom-food-fat').value) || 0;
                const fiber = parseFloat(document.getElementById('custom-food-fiber').value) || 0;
                
                if (!name || isNaN(amount) || amount <= 0 || isNaN(calories) || calories < 0) {
                    showError('لطفاً اطلاعات معتبری وارد کنید');
                    return;
                }
                
                const foodEntry = {
                    name, amount, calories: Math.round(calories),
                    protein: parseFloat(protein.toFixed(1)),
                    carbs: parseFloat(carbs.toFixed(1)),
                    fat: parseFloat(fat.toFixed(1)),
                    fiber: parseFloat(fiber.toFixed(1))
                };
                
                await addFoodToCurrentMeal(foodEntry);
                
                // Reset form
                document.getElementById('custom-food-name').value = '';
                document.getElementById('custom-food-amount').value = '100';
                document.getElementById('custom-food-calories').value = '0';
                document.getElementById('custom-food-protein').value = '0';
                document.getElementById('custom-food-carbs').value = '0';
                document.getElementById('custom-food-fat').value = '0';
                document.getElementById('custom-food-fiber').value = '0';
            });
            
            // Save custom food to database
            document.getElementById('save-to-database-btn').addEventListener('click', async function() {
                const name = document.getElementById('custom-food-name').value.trim();
                const baseAmount = parseFloat(document.getElementById('custom-food-amount').value);
                const calories = parseFloat(document.getElementById('custom-food-calories').value);
                const protein = parseFloat(document.getElementById('custom-food-protein').value) || 0;
                const carbs = parseFloat(document.getElementById('custom-food-carbs').value) || 0;
                const fat = parseFloat(document.getElementById('custom-food-fat').value) || 0;
                const fiber = parseFloat(document.getElementById('custom-food-fiber').value) || 0;
                
                if (!name || isNaN(calories) || calories < 0) {
                    showError('لطفاً اطلاعات معتبری وارد کنید');
                    return;
                }
                
                // Check for duplicates
                const existingFood = appState.foods.find(food => 
                    food.name.toLowerCase() === name.toLowerCase()
                );
                
                if (existingFood) {
                    showError(`غذایی با نام "${name}" قبلاً در پایگاه داده وجود دارد`);
                    return;
                }
                
                // Normalize to 100g
                const ratio = 100 / baseAmount;
                const foodData = {
                    name,
                    calories: Math.round(calories * ratio),
                    protein: parseFloat((protein * ratio).toFixed(1)),
                    carbs: parseFloat((carbs * ratio).toFixed(1)),
                    fat: parseFloat((fat * ratio).toFixed(1)),
                    fiber: parseFloat((fiber * ratio).toFixed(1)),
                    category: 'other',
                    isPublic: false
                };
                
                await addFoodToDatabase(foodData);
            });
        }
        
        // Setup database management
        function setupDatabaseManagement() {
            // Add food to database
            document.getElementById('add-db-food-btn').addEventListener('click', async function() {
                const name = document.getElementById('db-food-name').value.trim();
                const category = document.getElementById('db-food-category').value;
                const calories = parseFloat(document.getElementById('db-food-calories').value);
                const protein = parseFloat(document.getElementById('db-food-protein').value) || 0;
                const carbs = parseFloat(document.getElementById('db-food-carbs').value) || 0;
                const fat = parseFloat(document.getElementById('db-food-fat').value) || 0;
                const fiber = parseFloat(document.getElementById('db-food-fiber').value) || 0;
                
                if (!name || isNaN(calories) || calories < 0) {
                    showError('لطفاً اطلاعات معتبری وارد کنید');
                    return;
                }
                
                const existingFood = appState.foods.find(food => 
                    food.name.toLowerCase() === name.toLowerCase()
                );
                
                if (existingFood) {
                    showError(`غذایی با نام "${name}" قبلاً در پایگاه داده وجود دارد`);
                    return;
                }
                
                const foodData = {
                    name, category, calories: Math.round(calories),
                    protein: parseFloat(protein.toFixed(1)),
                    carbs: parseFloat(carbs.toFixed(1)),
                    fat: parseFloat(fat.toFixed(1)),
                    fiber: parseFloat(fiber.toFixed(1)),
                    isPublic: false
                };
                
                await addFoodToDatabase(foodData);
                
                // Reset form
                document.getElementById('db-food-name').value = '';
                document.getElementById('db-food-calories').value = '0';
                document.getElementById('db-food-protein').value = '0';
                document.getElementById('db-food-carbs').value = '0';
                document.getElementById('db-food-fat').value = '0';
                document.getElementById('db-food-fiber').value = '0';
            });
            
            // Database search
            let searchTimeout;
            document.getElementById('db-search').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    updateFoodDatabaseTable(this.value);
                }, 300);
            });
            
            // Category filter
            document.getElementById('food-category-filter').addEventListener('change', function() {
                const searchQuery = document.getElementById('db-search').value;
                updateFoodDatabaseTable(searchQuery, this.value);
            });
            
            // Clear search
            document.getElementById('clear-search').addEventListener('click', function() {
                document.getElementById('db-search').value = '';
                document.getElementById('food-category-filter').value = '';
                updateFoodDatabaseTable();
            });
            
            // Load complete database
            document.getElementById('load-complete-database').addEventListener('click', async function() {
                showConfirmDialog(
                    'بارگذاری دیتابیس کامل',
                    'آیا می‌خواهید دیتابیس کامل ۳۸۰+ غذا را بارگذاری کنید؟ این عمل ممکن است چند دقیقه طول بکشد.',
                    async () => {
                        try {
                            showLoading('بارگذاری دیتابیس کامل...');
                            
                            if (appState.isOnline && appState.authToken) {
                                const result = await loadCompleteDatabase();
                                showSuccess(result.message);
                            } else {
                                showError('برای بارگذاری دیتابیس کامل باید در حالت آنلاین باشید');
                            }
                            
                            updateFoodDatabaseTable();
                        } catch (error) {
                            showError('خطا در بارگذاری دیتابیس: ' + error.message);
                        } finally {
                            hideLoading();
                        }
                    }
                );
            });
        }
        
        // Setup settings
        function setupSettings() {
            // Save settings
            document.getElementById('save-settings').addEventListener('click', async function() {
                const name = document.getElementById('user-name').value.trim();
                const caloriePrecision = parseInt(document.getElementById('calorie-precision').value);
                const nutrientPrecision = parseInt(document.getElementById('nutrient-precision').value);
                const themeMode = document.querySelector('input[name="theme-mode"]:checked').value;
                
                const newSettings = {
                    theme: themeMode,
                    caloriePrecision,
                    nutrientPrecision
                };
                
                try {
                    if (appState.isOnline && appState.authToken) {
                        await updateUserProfile({ name, settings: newSettings });
                    }
                    
                    appState.settings = newSettings;
                    if (appState.user) {
                        appState.user.name = name;
                    }
                    
                    if (!appState.isOnline) {
                        saveToLocalStorage();
                    }
                    
                    updateThemeUI();
                    updateAllUI();
                    
                    showSuccess('تنظیمات با موفقیت ذخیره شد');
                } catch (error) {
                    showError('خطا در ذخیره تنظیمات: ' + error.message);
                }
            });
            
            // Reset buttons
            setupResetButtons();
        }
        
        // Update settings UI
        function updateSettingsUI() {
            document.getElementById('user-name').value = appState.user?.name || '';
            document.getElementById('calorie-precision').value = appState.settings.caloriePrecision;
            document.getElementById('nutrient-precision').value = appState.settings.nutrientPrecision;
            
            const themeRadio = document.querySelector(`input[name="theme-mode"][value="${appState.settings.theme}"]`);
            if (themeRadio) {
                themeRadio.checked = true;
            }
        }
        
        // Setup reset buttons
        function setupResetButtons() {
            document.getElementById('reset-goals').addEventListener('click', function() {
                showConfirmDialog(
                    'بازنشانی اهداف',
                    'آیا از بازنشانی اهداف به مقادیر پیش‌فرض اطمینان دارید؟',
                    () => {
                        appState.goals = {
                            calories: 2000,
                            protein: 80,
                            carbs: 250,
                            fat: 65,
                            water: 2.5
                        };
                        
                        updateGoalsInputs();
                        updateAllUI();
                        saveToLocalStorage();
                        
                        showSuccess('اهداف با موفقیت بازنشانی شد');
                    }
                );
            });
            
            document.getElementById('clear-logs').addEventListener('click', function() {
                showConfirmDialog(
                    'حذف گزارش‌ها',
                    'آیا از حذف تمام اطلاعات تغذیه اطمینان دارید؟',
                    () => {
                        appState.dailyMeals = {
                            breakfast: [], lunch: [], dinner: [], snack: []
                        };
                        appState.dailyTotals = {
                            calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0, water: 0
                        };
                        
                        updateAllUI();
                        saveToLocalStorage();
                        
                        showSuccess('اطلاعات تغذیه با موفقیت پاک شد');
                    }
                );
            });
            
            document.getElementById('reset-foods').addEventListener('click', function() {
                showConfirmDialog(
                    'حذف غذاهای شخصی',
                    'آیا از حذف تمام غذاهای شخصی اطمینان دارید؟',
                    () => {
                        appState.foods = appState.foods.filter(food => food.isPublic || !food.createdBy);
                        
                        if (appState.currentTab === 'database') {
                            updateFoodDatabaseTable();
                        }
                        
                        saveToLocalStorage();
                        showSuccess('غذاهای شخصی با موفقیت حذف شد');
                    }
                );
            });
            
            document.getElementById('reset-all').addEventListener('click', function() {
                showConfirmDialog(
                    'حذف همه داده‌ها',
                    'آیا از حذف تمام داده‌های برنامه اطمینان دارید؟ این عمل قابل بازگشت نیست.',
                    () => {
                        localStorage.clear();
                        showSuccess('تمام داده‌ها با موفقیت پاک شد. صفحه بازنشانی می‌شود...');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                );
            });
        }
        
        // Setup authentication
        function setupAuthentication() {
            // Login form
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('login-email').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Register form
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            
            // Form switching
            document.getElementById('show-register-btn').addEventListener('click', function() {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            });
            
            document.getElementById('show-login-btn').addEventListener('click', function() {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            });
            
            // Offline mode
            document.getElementById('offline-mode-btn').addEventListener('click', function() {
                appState.isOnline = false;
                hideLoginModal();
                updateConnectionStatus();
                loadFromLocalStorage();
                updateAllUI();
                showSuccess('حالت آفلاین فعال شد');
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Onboarding
            document.getElementById('onboard-complete-btn').addEventListener('click', function() {
                const calories = parseFloat(document.getElementById('onboard-calorie-goal').value) || 2000;
                const protein = parseFloat(document.getElementById('onboard-protein-goal').value) || 80;
                const carbs = parseFloat(document.getElementById('onboard-carbs-goal').value) || 250;
                const fat = parseFloat(document.getElementById('onboard-fat-goal').value) || 65;
                const water = parseFloat(document.getElementById('onboard-water-goal').value) || 2.5;
                
                appState.goals = { calories, protein, carbs, fat, water };
                
                document.getElementById('onboarding-modal').classList.add('hidden');
                
                updateGoalsInputs();
                updateAllUI();
                saveToLocalStorage();
                
                showSuccess('اطلاعات شما با موفقیت ذخیره شد');
            });
        }
        
        // Setup backup and restore
        function setupBackupRestore() {
            // Backup buttons
            document.getElementById('backup-btn').addEventListener('click', () => {
                if (appState.isOnline && appState.authToken) {
                    exportBackup();
                } else {
                    exportOfflineData();
                }
            });
            
            document.getElementById('backup-data').addEventListener('click', () => {
                if (appState.isOnline && appState.authToken) {
                    exportBackup();
                } else {
                    exportOfflineData();
                }
            });
            
            // Restore buttons
            document.getElementById('restore-btn').addEventListener('click', showImportModal);
            document.getElementById('restore-data').addEventListener('click', showImportModal);
            
            // Sync button
            document.getElementById('sync-btn').addEventListener('click', async function() {
                try {
                    showLoading('تلاش برای اتصال مجدد...');
                    
                    // Try to reconnect
                    const response = await fetch(`${API_BASE_URL}/user/profile`, {
                        headers: {
                            'Authorization': `Bearer ${appState.authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        appState.isOnline = true;
                        updateConnectionStatus();
                        await initializeApp();
                        showSuccess('اتصال برقرار شد و اطلاعات همگام‌سازی شد');
                    } else {
                        throw new Error('اتصال برقرار نشد');
                    }
                } catch (error) {
                    showError('امکان اتصال به سرور وجود ندارد');
                } finally {
                    hideLoading();
                }
            });
        }
        
        // Show import modal
        function showImportModal() {
            const modal = document.getElementById('import-modal');
            const fileInput = document.getElementById('import-file');
            const confirmBtn = document.getElementById('import-confirm');
            const cancelBtn = document.getElementById('import-cancel');
            const errorDiv = document.getElementById('import-error');
            
            // Reset
            fileInput.value = '';
            errorDiv.textContent = '';
            errorDiv.classList.add('hidden');
            
            modal.classList.remove('hidden');
            
            // Remove existing event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            newConfirmBtn.addEventListener('click', async () => {
                if (fileInput.files.length === 0) {
                    errorDiv.textContent = 'لطفاً یک فایل انتخاب کنید';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                try {
                    const file = fileInput.files[0];
                    
                    if (appState.isOnline && appState.authToken) {
                        await importBackup(file);
                        showSuccess('اطلاعات با موفقیت بازیابی شد');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        // Handle offline import
                        await importOfflineBackup(file);
                        showSuccess('اطلاعات آفلاین با موفقیت بازیابی شد');
                        updateAllUI();
                    }
                    
                    modal.classList.add('hidden');
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            });
            
            newCancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }
        
        // Import offline backup
        async function importOfflineBackup(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (data.type === 'offline-backup' && data.data) {
                            localStorage.setItem('calorieTracker_state', JSON.stringify(data.data));
                            loadFromLocalStorage();
                            resolve('اطلاعات آفلاین با موفقیت بازیابی شد');
                        } else {
                            reject(new Error('فرمت فایل پشتیبان نامعتبر است'));
                        }
                    } catch (error) {
                        reject(new Error('خطا در پردازش فایل پشتیبان'));
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('خطا در خواندن فایل'));
                };
                
                reader.readAsText(file);
            });
        }

        // ==================== Initialize App ====================
        
        // Initialize the application
        async function initializeApp() {
            try {
                showLoading('بارگذاری برنامه...');
                
                // Set current date
                document.getElementById('current-date').value = appState.currentDate;
                
                // Initialize charts
                initializeCharts();
                
                // Setup event listeners
                setupEventListeners();
                
                // Check authentication
                const hasAuth = checkAuthentication();
                
                if (hasAuth && !OFFLINE_MODE) {
                    // Try to get user profile
                    try {
                        const userProfile = await getUserProfile();
                        appState.user = userProfile;
                        appState.goals = userProfile.goals || appState.goals;
                        appState.settings = userProfile.settings || appState.settings;
                        
                        // Show logout button
                        document.getElementById('logout-btn').classList.remove('hidden');
                        
                        // Load data
                        await loadDailyData();
                        await loadFoods();
                        await loadCategories();
                        
                    } catch (error) {
                        console.error('Failed to load user profile:', error);
                        appState.isOnline = false;
                        loadFromLocalStorage();
                    }
                } else {
                    // Offline mode or no auth
                    appState.isOnline = false;
                    loadFromLocalStorage();
                    
                    if (!OFFLINE_MODE) {
                        showLoginModal();
                    }
                }
                
                // Update UI
                updateConnectionStatus();
                updateThemeUI();
                updateAllUI();
                
                // Listen for theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (appState.settings.theme === 'system') {
                        updateThemeUI();
                    }
                });
                
                // Listen for online/offline events
                window.addEventListener('online', () => {
                    console.log('App went online');
                    // Could implement auto-sync here
                });
                
                window.addEventListener('offline', () => {
                    console.log('App went offline');
                    appState.isOnline = false;
                    updateConnectionStatus();
                });
                
            } catch (error) {
                console.error('Failed to initialize app:', error);
                showError('خطا در بارگذاری برنامه: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ==================== App Entry Point ====================
        
        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Initialize dark mode detection
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            // Start the app
            initializeApp();
        });
    </script>


</body></html>